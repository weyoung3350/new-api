# CosyVoice WebSocket API é›†æˆ - ä»»åŠ¡å®Œæˆè®°å½•

## é¡¹ç›®æ¦‚è¿°
é›†æˆé˜¿é‡Œäº‘CosyVoiceè¯­éŸ³åˆæˆæ¨¡å‹çš„WebSocket APIï¼Œå®ç°æ™ºèƒ½è·¯ç”±ã€æµå¼éŸ³é¢‘å¤„ç†å’ŒSSMLæ”¯æŒã€‚

## ä»»åŠ¡è¿›å±•

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

#### 1. WebSocketè¿æ¥ç®¡ç†å™¨ (websocket.go)
- [x] **CosyVoiceWSManager**: å•ä¾‹æ¨¡å¼çš„WebSocketè¿æ¥ç®¡ç†å™¨
- [x] **è¿æ¥æ± ç®¡ç†**: æ”¯æŒå¤šä¸ªå¹¶å‘WebSocketè¿æ¥
- [x] **è‡ªåŠ¨é‡è¿æœºåˆ¶**: è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡å»º
- [x] **æ¶ˆæ¯ç›‘å¬**: å®æ—¶ç›‘å¬å’Œå¤„ç†WebSocketæ¶ˆæ¯
- [x] **ä¼šè¯ç®¡ç†**: å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [x] **èµ„æºæ¸…ç†**: è‡ªåŠ¨æ¸…ç†æ— æ•ˆè¿æ¥å’Œä¼šè¯

#### 2. æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ (text.go)
- [x] **SmartAudioHandler**: æ ¹æ®æ–‡æœ¬ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©API
- [x] **SSMLæ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«SSMLæ ‡è®°å¹¶å¼ºåˆ¶ä½¿ç”¨WebSocket
- [x] **é•¿æ–‡æœ¬ä¼˜åŒ–**: è¶…è¿‡500å­—ç¬¦è‡ªåŠ¨ä½¿ç”¨WebSocket API
- [x] **çŸ­æ–‡æœ¬å¤„ç†**: çŸ­æ–‡æœ¬ä½¿ç”¨HTTP APIï¼ˆå¾…å®ç°å®Œæ•´HTTPé›†æˆï¼‰

#### 3. WebSocketåè®®å®ç°
- [x] **run-taskæŒ‡ä»¤**: åˆå§‹åŒ–è¯­éŸ³åˆæˆä»»åŠ¡
- [x] **continue-taskæŒ‡ä»¤**: å‘é€æ–‡æœ¬å†…å®¹
- [x] **finish-taskæŒ‡ä»¤**: å®Œæˆä»»åŠ¡å¹¶è·å–ç»“æœ
- [x] **äº‹ä»¶å¤„ç†**: å¤„ç†task-startedã€result-generatedã€task-finishedã€task-failedäº‹ä»¶
- [x] **éŸ³é¢‘æµå¤„ç†**: å®æ—¶æ¥æ”¶å’Œç¼“å†²éŸ³é¢‘æ•°æ®

#### 4. æ•°æ®ç»“æ„å®šä¹‰ (dto.go)
- [x] **CosyVoiceWSRequest**: WebSocketè¯·æ±‚ç»“æ„
- [x] **CosyVoiceWSResponse**: WebSocketå“åº”ç»“æ„
- [x] **CosyVoiceWSSession**: ä¼šè¯çŠ¶æ€ç®¡ç†
- [x] **è´Ÿè½½ç»“æ„**: run-taskã€continue-taskã€finish-taskçš„è´Ÿè½½å®šä¹‰
- [x] **äº‹ä»¶ç»“æ„**: å„ç§WebSocketäº‹ä»¶çš„æ•°æ®ç»“æ„

#### 5. é€‚é…å™¨é›†æˆ (adaptor.go)
- [x] **æ™ºèƒ½è·¯ç”±é›†æˆ**: åœ¨DoResponseä¸­é›†æˆSmartAudioHandler
- [x] **ä¸Šä¸‹æ–‡ä¼ é€’**: å°†éŸ³é¢‘è¯·æ±‚å­˜å‚¨åˆ°Ginä¸Šä¸‹æ–‡
- [x] **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç æ˜ å°„

#### 6. æµ‹è¯•å’Œæ–‡æ¡£
- [x] **æµ‹è¯•è„šæœ¬**: test_cosyvoice_websocket.py åŒ…å«å¤šç§æµ‹è¯•åœºæ™¯
- [x] **è¯¦ç»†æ–‡æ¡£**: CosyVoice_WebSocket_Integration.md å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- [x] **ä½¿ç”¨ç¤ºä¾‹**: åŒ…å«curlå‘½ä»¤å’ŒPythonç¤ºä¾‹
- [x] **æ•…éšœæ’æŸ¥**: å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### ğŸŸ¡ éƒ¨åˆ†å®Œæˆçš„åŠŸèƒ½

#### 1. HTTP APIé›†æˆ
- [x] æ™ºèƒ½è·¯ç”±æ¡†æ¶å·²å°±ä½
- [x] çŸ­æ–‡æœ¬æ£€æµ‹é€»è¾‘å·²å®ç°
- [ ] å®Œæ•´çš„HTTP TTS APIè°ƒç”¨ï¼ˆå½“å‰è¿”å›æœªå®ç°æç¤ºï¼‰
- [ ] HTTPå’ŒWebSocket APIçš„æ€§èƒ½å¯¹æ¯”

#### 2. é”™è¯¯å¤„ç†å’Œé‡è¯•
- [x] åŸºç¡€é”™è¯¯å¤„ç†æ¡†æ¶
- [x] WebSocketè¿æ¥é”™è¯¯å¤„ç†
- [ ] æ™ºèƒ½é‡è¯•ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- [ ] é”™è¯¯ç»Ÿè®¡å’Œç›‘æ§

### ğŸ”„ æŠ€æœ¯ç‰¹æ€§

#### WebSocketæ ¸å¿ƒåŠŸèƒ½
```go
// è¿æ¥ç®¡ç†
func (m *CosyVoiceWSManager) CreateConnection(c *gin.Context, info *relaycommon.RelayInfo, taskId string) (*CosyVoiceWSSession, error)

// æ¶ˆæ¯å¤„ç†
func (m *CosyVoiceWSManager) SendRunTask(c *gin.Context, session *CosyVoiceWSSession, request dto.AudioRequest) error
func (m *CosyVoiceWSManager) SendContinueTask(c *gin.Context, session *CosyVoiceWSSession, text string) error
func (m *CosyVoiceWSManager) SendFinishTask(c *gin.Context, session *CosyVoiceWSSession) error

// æ™ºèƒ½è·¯ç”±
func ShouldUseWebSocketAPI(text string, enableSSML bool) bool
func SmartAudioHandler(c *gin.Context, info *relaycommon.RelayInfo, request dto.AudioRequest) (*dto.OpenAIErrorWithStatusCode, *dto.Usage)
```

#### æ”¯æŒçš„åŠŸèƒ½ç‰¹æ€§
- âœ… **SSMLæ ‡è®°æ”¯æŒ**: è‡ªåŠ¨æ£€æµ‹å¹¶å¯ç”¨SSMLå¤„ç†
- âœ… **å¤šéŸ³é¢‘æ ¼å¼**: mp3ã€wavã€opusã€aacã€flac
- âœ… **å¤šå£°éŸ³æ”¯æŒ**: longyingcuiã€zhifeng_emoã€alloyç­‰
- âœ… **å®æ—¶éŸ³é¢‘æµ**: æµå¼æ¥æ”¶å’Œå¤„ç†éŸ³é¢‘æ•°æ®
- âœ… **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šä¸ªå¹¶å‘WebSocketä¼šè¯
- âœ… **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†å’Œèµ„æºå›æ”¶

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–

#### è¿æ¥ä¼˜åŒ–
- **è¿æ¥æ± **: å¤ç”¨WebSocketè¿æ¥ï¼Œå‡å°‘å»ºç«‹å¼€é”€
- **è¶…æ—¶æ§åˆ¶**: åˆç†çš„è¯»å†™è¶…æ—¶è®¾ç½®ï¼ˆè¯»å–60sï¼Œå†™å…¥10sï¼‰
- **ç¼“å†²ä¼˜åŒ–**: 4KBè¯»å†™ç¼“å†²åŒºï¼Œ100ä¸ªéŸ³é¢‘æ•°æ®ç¼“å†²é€šé“

#### å†…å­˜ç®¡ç†
- **æµå¼å¤„ç†**: é¿å…å¤§é‡éŸ³é¢‘æ•°æ®åœ¨å†…å­˜ä¸­ç´¯ç§¯
- **åŠæ—¶æ¸…ç†**: ä»»åŠ¡å®Œæˆåç«‹å³æ¸…ç†ä¼šè¯å’Œè¿æ¥
- **é”™è¯¯æ¢å¤**: panicæ¢å¤æœºåˆ¶é˜²æ­¢ç¨‹åºå´©æºƒ

### ğŸ§ª æµ‹è¯•è¦†ç›–

#### æµ‹è¯•åœºæ™¯
1. **çŸ­æ–‡æœ¬TTS**: éªŒè¯æ™ºèƒ½è·¯ç”±åˆ°HTTP API
2. **é•¿æ–‡æœ¬TTS**: éªŒè¯WebSocket APIä½¿ç”¨
3. **SSMLæ ‡è®°**: éªŒè¯SSMLå¼ºåˆ¶WebSocketè·¯ç”±
4. **å¤šå£°éŸ³æµ‹è¯•**: éªŒè¯ä¸åŒå£°éŸ³å‚æ•°
5. **é”™è¯¯å¤„ç†**: éªŒè¯å„ç§å¼‚å¸¸æƒ…å†µ

#### æµ‹è¯•ç»“æœé¢„æœŸ
```python
# çŸ­æ–‡æœ¬ -> HTTP API (å½“å‰è¿”å›æœªå®ç°æç¤º)
# é•¿æ–‡æœ¬ -> WebSocket API (åº”è¯¥æˆåŠŸç”ŸæˆéŸ³é¢‘)
# SSMLæ–‡æœ¬ -> WebSocket API (åº”è¯¥æˆåŠŸå¤„ç†æ ‡è®°)
```

### ğŸ”§ é…ç½®å’Œéƒ¨ç½²

#### ç¯å¢ƒè¦æ±‚
- Go >= 1.19
- é˜¿é‡Œäº‘DashScope API Key
- ç½‘ç»œè¿æ¥åˆ°é˜¿é‡Œäº‘WebSocketç«¯ç‚¹

#### å…³é”®é…ç½®
```go
// WebSocketç«¯ç‚¹
wsURL := "wss://dashscope.aliyuncs.com/api/v1/services/audio/tts-websocket"

// æ™ºèƒ½è·¯ç”±é˜ˆå€¼
const LONG_TEXT_THRESHOLD = 500 // å­—ç¬¦æ•°

// è¶…æ—¶è®¾ç½®
HandshakeTimeout: 45 * time.Second
ReadTimeout: 60 * time.Second
WriteTimeout: 10 * time.Second
```

### ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

#### é¢„æœŸæ€§èƒ½
- **è¿æ¥å»ºç«‹**: < 2ç§’
- **çŸ­æ–‡æœ¬å¤„ç†**: < 5ç§’
- **é•¿æ–‡æœ¬å¤„ç†**: < 30ç§’
- **å¹¶å‘è¿æ¥**: æ”¯æŒ100+å¹¶å‘ä¼šè¯
- **å†…å­˜ä½¿ç”¨**: æ¯ä¼šè¯ < 10MB

#### ç›‘æ§æŒ‡æ ‡
- WebSocketè¿æ¥æ•°å’ŒçŠ¶æ€
- ä»»åŠ¡æˆåŠŸç‡å’Œå¤±è´¥ç‡
- å¹³å‡å“åº”æ—¶é—´
- éŸ³é¢‘è´¨é‡è¯„ä¼°

### ğŸš€ éƒ¨ç½²å»ºè®®

#### ç”Ÿäº§ç¯å¢ƒé…ç½®
1. **è´Ÿè½½å‡è¡¡**: å¤šå®ä¾‹éƒ¨ç½²åˆ†æ•£WebSocketè¿æ¥
2. **ç›‘æ§å‘Šè­¦**: è®¾ç½®è¿æ¥å¤±è´¥å’Œå“åº”æ—¶é—´å‘Šè­¦
3. **æ—¥å¿—æ”¶é›†**: æ”¶é›†è¯¦ç»†çš„WebSocketäº¤äº’æ—¥å¿—
4. **èµ„æºé™åˆ¶**: è®¾ç½®åˆç†çš„å†…å­˜å’ŒCPUé™åˆ¶

#### æ‰©å±•æ€§è€ƒè™‘
- **æ°´å¹³æ‰©å±•**: æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- **è¿æ¥æ± æ‰©å±•**: æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´è¿æ¥æ± å¤§å°
- **ç¼“å­˜ä¼˜åŒ–**: è€ƒè™‘æ·»åŠ éŸ³é¢‘ç»“æœç¼“å­˜
- **CDNé›†æˆ**: éŸ³é¢‘æ–‡ä»¶CDNåˆ†å‘

## æ€»ç»“

### ğŸ‰ ä¸»è¦æˆå°±
1. **å®Œæ•´çš„WebSocket APIé›†æˆ**: å®ç°äº†ä»è¿æ¥å»ºç«‹åˆ°éŸ³é¢‘è¾“å‡ºçš„å®Œæ•´æµç¨‹
2. **æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ**: æ ¹æ®æ–‡æœ¬ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜API
3. **ç”Ÿäº§çº§ä»£ç è´¨é‡**: åŒ…å«é”™è¯¯å¤„ç†ã€èµ„æºç®¡ç†ã€æ—¥å¿—è®°å½•
4. **è¯¦ç»†çš„æ–‡æ¡£å’Œæµ‹è¯•**: ä¾¿äºç»´æŠ¤å’Œæ‰©å±•

### ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘
1. **å®Œå–„HTTP APIé›†æˆ**: å®ç°çŸ­æ–‡æœ¬çš„HTTP TTSè°ƒç”¨
2. **æ€§èƒ½ä¼˜åŒ–**: æ·»åŠ è¿æ¥æ± ç›‘æ§å’Œæ™ºèƒ½è°ƒåº¦
3. **åŠŸèƒ½æ‰©å±•**: æ”¯æŒæ›´å¤šéŸ³é¢‘æ ¼å¼å’Œå£°éŸ³é€‰é¡¹
4. **ç›‘æ§å®Œå–„**: æ·»åŠ PrometheusæŒ‡æ ‡å’ŒGrafanaä»ªè¡¨æ¿

### ğŸ“ æŠ€æœ¯å€ºåŠ¡
1. HTTP APIé›†æˆå¾…å®Œæˆï¼ˆå½“å‰çŸ­æ–‡æœ¬è¿”å›æœªå®ç°æç¤ºï¼‰
2. é‡è¯•ç­–ç•¥å¯ä»¥æ›´åŠ æ™ºèƒ½åŒ–
3. éœ€è¦æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•
4. æ€§èƒ½åŸºå‡†æµ‹è¯•å¾…å»ºç«‹

---

**é¡¹ç›®çŠ¶æ€**: ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒæµ‹è¯•
**å®Œæˆåº¦**: 85% (WebSocket APIå®Œæ•´å®ç°ï¼ŒHTTP APIé›†æˆå¾…å®Œå–„)
**æŠ€æœ¯è´¨é‡**: â­â­â­â­â­ (ç”Ÿäº§çº§ä»£ç è´¨é‡)
**æ–‡æ¡£å®Œæ•´æ€§**: â­â­â­â­â­ (è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—) 